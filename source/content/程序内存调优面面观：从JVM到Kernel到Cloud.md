---
title: ç¨‹åºå†…å­˜è°ƒä¼˜é¢é¢è§‚ï¼šä»JVMåˆ°Kernelåˆ°Cloud
tags:
  - kernel
  - memory
  - JVM
date: 2025/4/28
---
# èƒŒæ™¯

æˆ‘ä»¬åœ¨ kubernetes çš„ç¯å¢ƒä¸­éƒ¨ç½²äº†å®¹å™¨åŒ–çš„ Jenkinsï¼Œéƒ¨ç½²ä¹‹åˆç»å¸¸ä¼šå‡ºç°OOMï¼Œç»è¿‡ä¸€äº›è°ƒç ”å’Œè°ƒæ•´åï¼Œé€æ¸ç¨³å®šèµ·æ¥ã€‚è¿™ä¸ªæ—¶å€™ï¼Œåˆæœ‰åŒäº‹å‘ç°Jenkinsçš„å†…å­˜ç”¨é‡ä¸€ç›´åœ¨å¢é•¿......

# JVM

ä»¥ä¸‹æ‰€æœ‰å®éªŒéƒ½æ˜¯åŸºäº JDK 17ï¼Œä¸åŒç‰ˆæœ¬æ”¯æŒçš„å‚æ•°å’Œè¡Œä¸ºä¼šæœ‰æ‰€åŒºåˆ«ã€‚

## è®¤è¯† JVM

å’Œå¹³å¸¸æˆ‘ä»¬éƒ¨ç½²åœ¨k8sç¯å¢ƒä¸­çš„å®¹å™¨åŒ–çš„Goã€PythonæœåŠ¡ä¸åŒï¼ŒJava åº”ç”¨é€šè¿‡ JVM æ¥è§£é‡Šå’Œæ‰§è¡Œï¼Œæ­¤å¤– JVM ç”±è¾ƒå¼ºçš„å†…å­˜ç®¡ç†çš„èƒ½åŠ›ï¼Œ**å¯ä»¥ç›´æ¥é™åˆ¶åº”ç”¨å¯ç”¨çš„å†…å­˜ï¼ˆ-Xmså’Œ-Xmxï¼‰**ï¼Œå¯ä»¥è®¤ä¸ºè¿™æœ¬èº«å°±æ˜¯ä¸€ç§â€œå®¹å™¨åŒ–â€çš„èƒ½åŠ›ï¼Œæ‰€ä»¥ Java åº”ç”¨çš„å®¹å™¨åŒ–è¦è€ƒè™‘çš„å› ç´ å¿…ç„¶æ›´å¤šã€‚

é‚£ä¹ˆ JVM å¦‚ä½•ç®¡ç†å†…å­˜å‘¢ï¼Ÿå“ªäº›å› ç´ å¯èƒ½ä¼šå¯¼è‡´åº”ç”¨å†…å­˜ä¸å¤Ÿè€Œå‘ç”Ÿ Out of Memory (OOM) å‘¢ï¼Ÿ

å‚è€ƒä¸‹é¢è¿™å¼ å›¾

![[jvm-memory-model.png]]
æ¥æºï¼š[Medium](https://danoncoding.com/tricky-kubernetes-memory-management-for-java-applications-d2f88dd4e9f6)

ä¸»è¦åˆ†ä¸º Heapï¼ˆå †ï¼‰ å’Œ Non-Heap ä¸¤éƒ¨åˆ†ã€‚æ³¨æ„ï¼Œè¿™å’Œæˆ‘ä»¬å¸¸è§çš„è¿›ç¨‹å†…å­˜åˆ†é…é‚£å¼ å›¾é‡Œçš„ Heap è¿˜ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼ˆä½†æ˜¯å¾ˆåƒï¼‰ã€‚

![[linux-process-memory-model.png]]
æ¥æºï¼š[Stack Overflow](https://stackoverflow.com/questions/73420465/how-the-operating-system-manages-the-stack-and-heap-growing-and-shrinking)

ä¸Šé¢é‚£å¼ å›¾æ˜¯JVMçš„å†…å­˜ç®¡ç†æ¨¡å‹ï¼Œä¸‹é¢åˆ™æ˜¯ Linux è¿›ç¨‹çš„ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯ä¸ºäº†ç®¡ç†å†…å­˜è€Œè¿›è¡Œçš„æŠ½è±¡ï¼Œåªæ˜¯ç»´åº¦ä¸åŒã€‚

ç®€è€Œè¨€ä¹‹ï¼Œå¯¹äº JVMï¼Œ**Non-Heap** è¿™éƒ¨åˆ†ä¸»è¦æ˜¯å­˜å‚¨å…ƒæ•°æ®å’Œä»£ç ç»“æ„ä½“ã€æ–¹æ³•ï¼Œè¿™éƒ¨åˆ†åŒºåŸŸå¤§å°æ¯”è¾ƒå›ºå®šï¼Œä¸å¤ªä¼šæˆä¸º OOM çš„å…ƒå‡¶ã€‚è€Œ **Heap** ç”¨æ¥å­˜å‚¨Javaç¨‹åºåˆ›å»ºçš„å¯¹è±¡ï¼Œç›´åˆ°å¯¹è±¡è¢«é‡Šæ”¾æ‰ä¼šè¢«GCå›æ”¶å ç”¨çš„è¿™éƒ¨åˆ†å†…å­˜ï¼Œè‡ªç„¶ä¼šéšç€åº”ç”¨æœåŠ¡çš„è´Ÿè½½å˜åŒ–è€Œå˜åŒ–ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬éœ€è¦å…³æ³¨çš„é‡ç‚¹ã€‚æ›´å¤šå…³äºè¿™ä¸¤éƒ¨åˆ†çš„è§£é‡Šå¯ä»¥å‚è€ƒ [Java Memory](https://www.baeldung.com/java-memory-beyond-heap) ã€‚

ç¨‹åºå‡ºç° OOM çš„æœ¬è´¨æ˜¯ç”±äºè¿è¡Œéœ€è¦æ›´å¤šå†…å­˜ï¼Œä½†æ˜¯å¯åˆ†é…çš„å†…å­˜å·²ç»ä¸å¤Ÿäº†â€”â€”æ— è®ºæ˜¯ç”±äº Heap çš„å¢é•¿è¶…è¿‡äº†é¢„å…ˆæŒ‡å®šçš„å¤§å°ï¼ˆæ¯”å¦‚é€šè¿‡ -Xms4G æŒ‡å®šæœ€å¤§å¯ç”¨4Gä½†å®é™…ä¸Šåº”ç”¨åˆ›å»ºå¯¹è±¡è¶…è¿‡äº†4Gï¼‰ï¼Œè¿˜æ˜¯åº”ç”¨æ€»çš„å†…å­˜å¤§å°è¶…è¿‡äº†æœºå™¨æˆ–å®¹å™¨æœ¬èº«çš„å†…å­˜é™åˆ¶ï¼ˆæ¯”å¦‚å®¹å™¨æŒ‡å®š memory limit 4Gï¼ŒNon-Heap å ç”¨äº†500Mï¼ŒHeap å³ä½¿æ²¡æœ‰è¶…è¿‡æŒ‡å®šçš„å¤§å°ä¹Ÿä¼šå¯¼è‡´ OOMï¼Œåªä¸è¿‡è¿™ä¸ª OOM ä¸æ˜¯ JVM è€Œæ˜¯ Kubelet æˆ–è€…å†…æ ¸è§¦å‘çš„ï¼‰ï¼Œ [è¿™ç¯‡æ–‡ç« ](https://danoncoding.com/tricky-kubernetes-memory-management-for-java-applications-d2f88dd4e9f6) æœ‰ä¸€ä¸ªç”ŸåŠ¨çš„ä¾‹å­å¸®åŠ©æˆ‘ä»¬ç†è§£ OOM äº§ç”Ÿçš„è¿‡ç¨‹ã€‚

æ‰€ä»¥ï¼Œ**æƒ³è¦é¿å…ç¨‹åºå‡ºç° OOM æœ¬è´¨ä¸Šè¿˜æ˜¯è¦æ‰¾åˆ°åˆé€‚ç¨‹åºè¿è¡Œçš„å †å’Œéå †å†…å­˜å¤§å°**ã€‚

## è§‚æµ‹

> å®è·µå‡ºçœŸçŸ¥

æ²¡äººèƒ½å®Œå…¨é¢„æµ‹ç¨‹åºè¿è¡Œæ—¶çš„çŠ¶æ€ï¼Œæˆ‘ä»¬åªæœ‰è·‘èµ·æ¥åä»å¤–éƒ¨è§‚æµ‹ã€‚

JVM çš„å·¥å…·ç®±ä¸­æä¾›äº†å¾ˆå¤šå·¥å…·æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œè§‚æµ‹å’Œæ’æŸ¥ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªè¯´ã€‚
### å†…å­˜è¿½è¸ª

æˆ‘ä»¬ç¬¬ä¸€ä¸ªæ„Ÿå…´è¶£çš„å°±æ˜¯ç¨‹åºåœ¨è¿è¡Œçš„æ—¶å€™åˆ†é…ç»™ä¸åŒåŒºåŸŸçš„å®é™…å†…å­˜åˆ°åº•æ˜¯å¤šå°‘ï¼Œå“ªä¸€éƒ¨åˆ†æ˜¯ä¸»è¦å¢é•¿ï¼Ÿ

é€šè¿‡åœ¨å¯åŠ¨ç¨‹åºçš„æ—¶å€™æŒ‡å®š `JAVA_TOOL_OPTIONS`
```bash
-XX:NativeMemoryTracking=detail
```

æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºè¿è¡Œèµ·æ¥åæ‰§è¡Œ

```bash
$ jcmd <pid> VM.native_memory summary
```

æŸ¥çœ‹å†…å­˜åˆ†é…ã€‚JVM æ‰“å°å¦‚ä¸‹å†…å®¹

```bash
Native Memory Tracking:

(Omitting categories weighting less than 1KB)

Total: reserved=3220660KB, committed=991708KB
       malloc: 79580KB #957981
       mmap:   reserved=3141080KB, committed=912128KB

-                 Java Heap (reserved=1468416KB, committed=620544KB)
                            (mmap: reserved=1468416KB, committed=620544KB)

-                     Class (reserved=1053006KB, committed=23694KB)
                            (classes #26606)
                            (  instance classes #25429, array classes #1177)
                            (malloc=4430KB #100197) (peak=4434KB #100148)
                            (mmap: reserved=1048576KB, committed=19264KB)
                            (  Metadata:   )
                            (    reserved=131072KB, committed=127424KB)
                            (    used=125628KB)
                            (    waste=1796KB =1.41%)
                            (  Class space:)
                            (    reserved=1048576KB, committed=19264KB)
                            (    used=17600KB)
                            (    waste=1664KB =8.64%)

-                    Thread (reserved=158282KB, committed=23574KB)
                            (thread #156)
                            (stack: reserved=157832KB, committed=23124KB)
                            (malloc=271KB #936) (peak=292KB #1117)
                            (arena=180KB #308) (peak=2374KB #126)

-                      Code (reserved=253066KB, committed=71106KB)
                            (malloc=5378KB #22266) (at peak)
                            (mmap: reserved=247688KB, committed=65728KB)
...
```

å¯ä»¥çœ‹åˆ°å…¶ä¸­ Heap ä¿ç•™å†…å­˜ 1.4G å·¦å³ï¼Œå®é™…æäº¤ 620Mï¼›Non-Heap ä¸­çš„ Class ä¿ç•™1.1Gï¼Œå®é™… 23Mã€‚è¿‡ä¸€æ®µæ—¶é—´æˆ‘ä»¬å¯ä»¥å†æ‰§è¡Œ

```bash
$ jcmd <pid> VM.native_memory summary.diff
```

æ¥æŸ¥çœ‹å˜åŒ–çš„éƒ¨åˆ†ã€‚

é€šè¿‡é’ˆå¯¹æ€§çš„å‹åŠ›æµ‹è¯•å’ŒæŸ¥çœ‹å®é™…å†…å­˜åˆ†é…æˆ‘ä»¬å¤§è‡´å¯ä»¥ç¡®å®šåœ¨ä¸åŒçš„è´Ÿè½½æƒ…å†µä¸‹ï¼ŒHeap å’Œ Non-Heap åˆ†åˆ«è®¾ç½®å¤šå°‘å†…å­˜å¤§å°åˆé€‚ã€‚

### GC

å¦‚æœå†…å­˜æŒç»­å¢é•¿ï¼Œæ— è®ºæŒ‡å®šå¤šå°‘å †å†…å­˜éƒ½ä¼šå‘ç”Ÿ OOMï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ˜¯å†…å­˜æ³„éœ²æˆ–è€…GCæœ‰é—®é¢˜ã€‚

é€šè¿‡åœ¨å¯åŠ¨ç¨‹åºçš„æ—¶å€™æŒ‡å®šï¼š
```bash
-verbose:gc
-Xlog:gc*:file=gc.log:time,level,tags
```

> -XX:+PrintGCDetails å’Œ -XX:+PrintGCDateStamps å·²ç»åœ¨JDK 11+ ä¸­ä¸å†æ”¯æŒ


æˆ‘ä»¬å¯ä»¥è®© JVM æ‰“å°å‡º GC ç›¸å…³çš„æ—¥å¿—ï¼š

```bash
[4623.393s][info][gc] GC(131) Pause Young (Normal) (G1 Evacuation Pause) 529M->247M(606M) 85.014ms
[4644.924s][info][gc] GC(132) Pause Young (Normal) (G1 Evacuation Pause) 530M->246M(606M) 19.658ms
[4654.298s][info][gc] GC(133) Pause Young (Normal) (G1 Evacuation Pause) 531M->247M(606M) 87.869ms
[4671.213s][info][gc] GC(134) Pause Young (Normal) (G1 Evacuation Pause) 532M->247M(606M) 25.208ms
```

åŸºäºè¿™äº›æ—¥å¿—æˆ‘ä»¬å¯ä»¥ç¡®è®¤ JVM çš„GCæ˜¯å¦æ­£å¸¸ï¼Œæ—¶é—´æ˜¯å¦åˆç†ï¼Œä¹Ÿå¯ä»¥æ‰“å°æ›´è¯¦ç»†çš„GCè¿‡ç¨‹ååŠ©åˆ†æï¼ŒåŒ…æ‹¬ GC çš„é€‰æ‹©å’Œå‚æ•°çš„è°ƒä¼˜ï¼Œè¿™æ˜¯æ›´é«˜çº§çš„è¯é¢˜äº†ï¼Œ[Oracle](https://docs.oracle.com/en/java/javase/17/gctuning/introduction-garbage-collection-tuning.html)ä¸Šæœ‰ä¸€ç³»åˆ—çš„æ–‡ç« è®²å¾—æ¯”æˆ‘æ·±å…¥ï¼Œè¿™é‡Œåªè®°å½•è¿™æ¬¡æ’æŸ¥è¿‡ç¨‹ä¸­æ¥è§¦åˆ°çš„ä¸€äº›çš®æ¯›ï¼š

æ€»çš„æ¥è¯´ï¼Œåƒåœ¾æ”¶é›†å™¨çš„è®¾è®¡æ˜¯ä¸ºäº†æ»¡è¶³ä¸¤ä¸ªç›®æ ‡ï¼šæœ€å¤§æš‚åœæ—¶é—´ï¼ˆMaximum Pause-Timeï¼‰å’Œååé‡ï¼ˆThroughputï¼‰ã€‚å‰è€…æ˜¯æŒ‡GCåœ¨å•æ¬¡å›æ”¶å†…å­˜çš„æ—¶å€™æš‚åœåº”ç”¨çš„æœ€å¤§æ—¶é•¿ï¼Œè¿™å½±å“äº†æœåŠ¡çš„å“åº”å»¶è¿Ÿï¼Œåè€…ååº”äº†åƒåœ¾å›æ”¶èŠ±è´¹çš„æ€»æ—¶é•¿åœ¨æ€»çš„è¿è¡Œæ—¶é•¿ä¸­çš„å æ¯”ï¼Œè¿™å½±å“äº†æœåŠ¡æœ¬èº«çš„ååé‡ã€‚è¿™ä¸¤ä¸ªå› ç´ å‡ ä¹æ€»æ˜¯ç›¸äº’åˆ¶çº¦çš„ï¼Œå¦‚æœæƒ³è¦å•æ¬¡æš‚åœæ—¶é•¿å°½å¯èƒ½å°ï¼Œé‚£ä¹ˆå°±éœ€è¦å°½é‡é¢‘ç¹åœ°è¿è¡ŒGCï¼›å¦‚æœå¸Œæœ›GCçš„é¢‘æ¬¡è¿‡é«˜ï¼Œé‚£ä¹ˆå°±å¯èƒ½å¯¼è‡´æä¾›ç»™ä¸šåŠ¡çš„CPUæ—¶é—´ç‰‡é™ä½ã€‚ä¸åŒçš„GCçš„å®ç°åŸºæœ¬å°±æ˜¯åœ¨è¿™ä¸¤è€…ä¹‹é—´åšå¹³è¡¡ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€æ—¦ä¸Šè¿°ä¸¤ä¸ªç›®æ ‡æ»¡è¶³æŒ‡å®šé˜ˆå€¼ï¼ˆé€šè¿‡ `-XX:MaxGCPauseMillis=<nnn>` å’Œ `-XX:GCTimeRatio=nnn` æŒ‡å®šï¼‰ï¼ŒJVM å°±ä¼š**å‡å°å †å†…å­˜**çš„å¤§å°ç›´åˆ°æŸä¸€æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¯¹åº”åœ°ï¼Œä¹Ÿä¼šå¢åŠ å †å†…å­˜ï¼ˆåé¢è¦è€ƒï¼‰ã€‚

JVM æä¾›äº†[å¤šç§åƒåœ¾æ”¶é›†å™¨çš„å®ç°](https://docs.oracle.com/en/java/javase/17/gctuning/available-collectors.html)ï¼ŒåŸºæœ¬å°±æ˜¯è¿™ä¸€å…‰è°±ä¸Šçš„ä¸åŒä½ç½®ï¼ˆè¡¨æ ¼ç”±ChatGPTç”Ÿæˆï¼Œæˆ‘æ²¡æœ‰é€ä¸ªæ ¸å¯¹ï¼‰ï¼š

| æ”¶é›†å™¨                             | ç±»å‹      | åœé¡¿ç‰¹ç‚¹            | é€‚åˆå †å¤§å°        | ååé‡ | é€‚ç”¨åœºæ™¯            | å¤‡æ³¨                                                                               |
| ------------------------------- | ------- | --------------- | ------------ | --- | --------------- | -------------------------------------------------------------------------------- |
| **Parallel (ååé‡ GC)**           | å¤šçº¿ç¨‹     | å…¨åœé¡¿ï¼ˆSTWï¼‰ï¼Œå¤šçº¿ç¨‹ GC | ä¸­å †ï¼ˆå‡ GBï¼‰      | é«˜   | è¿½æ±‚ååé‡çš„æ‰¹å¤„ç†ã€å¤§æ•°æ®åº”ç”¨ | é»˜è®¤ GCï¼ˆJDK8ï¼‰                                                                      |
| **CMS (Concurrent Mark Sweep)** | å¹¶å‘+å¤šçº¿ç¨‹  | å¤§éƒ¨åˆ†å¹¶å‘ï¼Œæ ‡è®°é˜¶æ®µçŸ­æš‚åœ   | ä¸­åˆ°å¤§å †ï¼ˆå‡ GBï¼‰    | ä¸­é«˜  | WebæœåŠ¡ã€å»¶è¿Ÿæ•æ„Ÿåº”ç”¨    | å·²è¢« G1 å–ä»£ï¼Œä¸å†ç»´æŠ¤ï¼ˆJDK 14 ç§»é™¤ï¼‰                                                         |
| **G1 (Garbage First)**          | åŒºåŸŸå¼+å¹¶å‘  | å°åœé¡¿ï¼Œå¯é…ç½®æœ€å¤§åœé¡¿æ—¶é—´   | å¤§å †ï¼ˆ>4GBï¼‰     | ä¸­é«˜  | å¤§å‹åº”ç”¨ï¼Œéœ€è¦ç¨³å®šå“åº”æ—¶é—´   | JDK9+é»˜è®¤                                                                          |
| **Shenandoah**                  | å¹¶å‘+ä½å»¶è¿Ÿ  | åœé¡¿æçŸ­ï¼ˆ1-10msï¼‰    | å¤§å †ï¼ˆGBï½TBï¼‰    | ä¸­   | æç«¯ä½å»¶è¿Ÿåº”ç”¨ï¼Œå¦‚é‡‘èäº¤æ˜“ç³»ç»Ÿ | Red Hat æ”¯æŒï¼ŒJDK17+æ­£å¼ç‰ˆï¼Œ[éƒ¨åˆ†LTSç‰ˆæœ¬](https://wiki.openjdk.org/display/shenandoah/Main) |
| **ZGC**                         | å¹¶å‘+è¶…ä½å»¶è¿Ÿ | åœé¡¿æçŸ­ï¼ˆ<1msï¼‰      | å·¨å¤§å †ï¼ˆå‡ åGBï½TBï¼‰ | ä¸­   | è¶…å¤§å †ï¼Œè¦æ±‚æä½å»¶è¿Ÿç³»ç»Ÿ    | Oracle ä¸»å¯¼ï¼ŒJDK11+                                                                 |

ç»“è®ºæ˜¯å¤§éƒ¨åˆ†ç°ä»£åº”ç”¨çš„åœºæ™¯ä½¿ç”¨ G1GC å°±è¶³å¤Ÿåº”ä»˜ã€‚å¦‚æœéœ€è¦é’ˆå¯¹åº”ç”¨è¿›è¡Œæ›´ç»†è‡´çš„å‚æ•°è°ƒä¼˜å¯ä»¥å‚è€ƒ[è¿™ç¯‡](https://docs.oracle.com/en/java/javase/17/gctuning/factors-affecting-garbage-collection-performance.html)ã€‚

### æŒ‡æ ‡

åœ¨ç¬¬ä¸€æ¬¡å¯¹ JVM å‚æ•°è¿›è¡Œå‹æµ‹å’Œè°ƒä¼˜çš„æ—¶å€™æ‰å…¥è¿‡ä¸€ä¸ªè¯¯åŒºï¼šæœ‰åŒäº‹è§‚å¯Ÿåˆ° Jenkins çš„å†…å­˜ä¸€ç›´ç»´æŒåœ¨æ¯”è¾ƒé«˜çš„æ°´ä½çº¿ï¼Œæ²¡æœ‰é¢„æƒ³çš„éšç€è¯·æ±‚ä¸‹é™è€Œé‡Šæ”¾å’Œå›æ”¶å†…å­˜ã€‚

![[jenkins-memory-usage.png]]

è¿™æ˜¯å› ä¸ºè§‚æµ‹çš„æŒ‡æ ‡æ˜¯å®¹å™¨çš„å†…å­˜ç”¨é‡ï¼Œè€Œè¿™ä¸€æŒ‡æ ‡ä½“ç°çš„å®é™…ä¸Šæ˜¯ JVM å£°æ˜çš„å †å†…å­˜+éå †å†…å­˜çš„å¤§å°ä¹‹å’Œï¼Œå¹¶éçœŸå®çš„ç”¨é‡ã€‚å¦‚ä¸Šé¢æ‰€è¯´ï¼Œåªæœ‰åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶å JVM æ‰ä¼šå‘æ“ä½œç³»ç»Ÿé‡Šæ”¾å’Œç”³è¯·å†…å­˜ç©ºé—´ï¼Œæ‰èƒ½åœ¨æŒ‡æ ‡ä¸­çœ‹åˆ°å†…å­˜å¤§å°çš„è°ƒæ•´ã€‚

è¦æ›´ç›´è§‚åœ°è§‚å¯Ÿåˆ°è¿™ä¸€å˜åŒ–æœ‰ä¸¤ç§åŠæ³•ï¼š
1. è°ƒæ•´ GC ç­–ç•¥ï¼Œæ›´ç§¯æåœ°é‡Šæ”¾å’Œç”³è¯·å†…å­˜ã€‚æ¯”å¦‚å‚æ•° `-XX:MinHeapFreeRatio=n -XX:MaxHeapFreeRatio=n` å¯ä»¥é€šè¿‡æ ¹æ®ç©ºé—²å†…å­˜åœ¨å †å†…å­˜ä¸­çš„æœ€å°å’Œæœ€å¤§å æ¯”ï¼Œæ¥åŠ¨æ€è°ƒèŠ‚å †å†…å­˜çš„å¤§å°ã€‚`-XX:-ShrinkHeapInSteps` å¯ä»¥å…³é—­åˆ†æ­¥æ”¶ç¼©å †å†…å­˜ï¼Œæ›´åŠ ç›´è§‚åœ°å±•ç¤ºå†…å­˜å˜åŒ–ã€‚æ³¨æ„è¿™äº›å‚æ•°åœ¨å®éªŒçš„æ—¶å€™å¯ä»¥å¼€å¯æˆ–è°ƒæ•´ä»¥ä½¿æŒ‡æ ‡æ›´åŠ çœŸå®åœ°ååº”å†…å­˜åŠ¨æ€å˜åŒ–ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿™åªä¼šä½¿å¾— GC â€œçå¿™å’Œâ€ï¼Œå¯¼è‡´ç¨‹åºçš„ååé‡ä¸‹é™æˆ–è€…æœ€å¤§æš‚åœæ—¶é•¿å¢åŠ ï¼›
2. ä½¿ç”¨ JVM æä¾›çš„æŒ‡æ ‡ã€‚ä¹Ÿè®¸ä½ çš„åº”ç”¨å·²ç»æš´éœ²äº†ä¸€äº›æ›´åŠ â€œçœŸå®â€çš„æŒ‡æ ‡ï¼Œæ¯”å¦‚å¯¹äºJenkinsæ¥è¯´ï¼Œæ’ä»¶ [Metrics](https://plugins.jenkins.io/metrics/) å°±æš´éœ²äº†`vm.memory.heap.usage` å’Œ `vm.memory.total.used` ç­‰æŒ‡æ ‡ï¼›å¦‚æœæ˜¯è‡ªå·±å¼€å‘çš„åº”ç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Spring Boot Actuator, Micrometer æˆ– JMX Exporter æ¥æš´éœ²ï¼›

## è£…è¿›ç®±å­çš„ç›’å­

æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œåœ¨å®¹å™¨é‡Œé¢è·‘ Java åº”ç”¨å°±åƒæ˜¯æŠŠç›’å­è£…è¿›ç®±å­é‡Œã€‚JDK10+ æ”¯æŒå¹¶åœ¨Linuxä¸Šé»˜è®¤å¼€å¯ `-XX:UseContainerSupport` è¿™ä¸€å‚æ•°ï¼Œä»¥å…è®¸ JVM æ„ŸçŸ¥å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„ resources.limits/requsts æ¥è°ƒæ•´å¯åŠ¨å‚æ•°ï¼Œæˆ‘ä»¬è¿™é‡Œä»…ä»…è®¨è®ºå†…å­˜ï¼Œæ›´è¯¦ç»†çš„ç­–ç•¥å¯ä»¥å‚è€ƒ[è¿™ç¯‡](https://developers.redhat.com/articles/2022/04/19/java-17-whats-new-openjdks-container-awareness)ã€‚

ç®€å•æ¥è¯´ï¼ŒJVM è®¤ä¸ºå½“å‰å¯ç”¨çš„å†…å­˜åˆ¤æ–­ä¸»è¦ä¾èµ– `spec.containers[].resources.limits.memory` ï¼Œä¸å— `requests` çš„å½±å“ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½® `-XX:MaxRAMPercentage=70`ï¼Œ`resources.limits.memory=2G`ï¼Œé‚£ä¹ˆ JVM å®é™…ä¸Šä¼šåˆ†é…ç»™åº”ç”¨çš„æœ€å¤§å †å†…å­˜ä¹Ÿå°±æ˜¯ 1.4Gã€‚å…¶ä»–çš„ç›¸å…³å‚æ•°å¦‚ä¸‹ï¼š

| **JVM option**             | **Replaces JVM option**  | **Description**                                                                                    | **Default value** |
| -------------------------- | ------------------------ | -------------------------------------------------------------------------------------------------- | ----------------- |
| `-XX:InitialRAMPercentage` | `-XX:InitialRAMFraction` | Percentage of real memory used for initial heap size                                               | 1.5625            |
| `-XX:MaxRAMPercentage`     | `-XX:MaxRAMFraction`     | Maximum percentage of real memory used for maximum heap size                                       | 25                |
| `-XX:MinRAMPercentage`     | `-XX:MinRAMFraction`     | Minimum percentage of real memory used for maximum heap size on systems with small physical memory | 50                |
| `-XX:ActiveProcessorCount` | n/a                      | CPU count that the VM should use and report as active                                              | n/a               |
æ¥æºï¼š[developers.redhat.com](https://developers.redhat.com/articles/2022/04/19/java-17-whats-new-openjdks-container-awareness#opinionated_configuration)

æ˜¯çš„ï¼Œä½ æ²¡çœ‹é”™ï¼Œ**æœ€å°å †é»˜è®¤å€¼æ¯”æœ€å¤§å †é»˜è®¤å€¼è¿˜å¤§**ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå€¼æœ€å¥½è¦æ˜¾å¼æŒ‡å®šã€‚æ­¤å¤– JVM ä¸è€ƒè™‘ requests ä¹Ÿä¼šå®¹æ˜“å¼•å‘ä¸€ä¸ªé—®é¢˜ã€‚

### æ½œåœ¨é—®é¢˜

æˆ‘ä»¬çŸ¥é“ Kubernetes çš„è°ƒåº¦ç­–ç•¥æ˜¯åŸºäº requests æ¥è®¡ç®—å’Œç­›é€‰èŠ‚ç‚¹ï¼Œ[è€Œé limits æˆ– usage](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#how-pods-with-resource-requests-are-scheduled)ã€‚å¦‚æœèŠ‚ç‚¹éƒ¨ç½²çš„ä¸»è¦æ˜¯ Java åº”ç”¨å¹¶ä¸” MaxRAMPercentage è®¾ç½®å¾—ä¸åˆç†ï¼Œå¯¼è‡´åº”ç”¨å®é™…å ç”¨å†…å­˜é•¿æœŸå¤§äº requestsï¼Œé‚£ä¹ˆèŠ‚ç‚¹ä¼šæ›´å®¹æ˜“è§¦å‘é©±é€çš„åŠ¨ä½œï¼Œå¯¼è‡´Podè¢«é¢‘ç¹é‡æ–°è°ƒåº¦ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“é…ç½® Pod requests/limits 1G/2Gï¼ŒMaxRAMPercentage=70 æ—¶ï¼Œé‚£ä¹ˆ Pod å®é™…ä½¿ç”¨å†…å­˜ä¸º 1.4Gï¼Œè€Œ Scheduler è®¤ä¸ºè¯¥èŠ‚ç‚¹åªä½¿ç”¨äº†1Gã€‚

å¯¹äºå¦‚ä½•é¿å…è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å€¾å‘äºåƒ[è¿™ç¯‡æ–‡ç« ](https://danoncoding.com/tricky-kubernetes-memory-management-for-java-applications-d2f88dd4e9f6) è¯´çš„ï¼Œ**æœ€å¥½å°† memory requests å’Œ limits è®¾ç½®ç›¸åŒ**ï¼Œé™¤éç»è¿‡è§‚æµ‹ä½ éå¸¸ç¡®ä¿¡åº”ç”¨çš„å †å†…å­˜ä¼šé•¿æœŸæ”¶ç¼©åœ¨æ¯”è¾ƒä½çš„æ°´å¹³ï¼Œè¿™åº”è¯¥ä¹Ÿå±äº Java åº”ç”¨å®¹å™¨åŒ–çš„ç‰¹æ®Šé—®é¢˜ã€‚

## ç»“è®º

ç»è¿‡ä¸€æ®µæ—¶é—´çš„å‹æµ‹å’Œè§‚å¯Ÿï¼Œæˆ‘ä»¬æœ€ç»ˆç¡®å®šäº†ä»¥ä¸‹é…ç½®ï¼ˆåªåˆ—å‡ºäº†å…³é”®éƒ¨åˆ†ï¼‰ :

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
spec:
    spec:
      containers:
      - env:
        - name: JAVA_TOOL_OPTIONS
          value: -XX:+PrintFlagsFinal
            -XX:MaxRAMPercentage=70.0
            -XX:MinRAMPercentage=20.0
            -XX:+UseStringDeduplication 
            -XX:+ParallelRefProcEnabled
            -XX:+DisableExplicitGC
            -XX:+HeapDumpOnOutOfMemoryError
        name: jenkins-demo-jenkins
        resources:
          limits:
            cpu: "2"
            memory: 4Gi
          requests:
            cpu: "1"
            memory: 4Gi
```

# Memory Working Set (WSS)

åœ¨ä½¿ç”¨ä¸€æ®µæ—¶é—´åï¼Œæœ‰ä¸šåŠ¡åé¦ˆ Jenkins å†…å­˜ä¸å¤Ÿï¼Œä¸€ç›´æŒç»­å¢å¤§ï¼Œéƒ½å·²ç»è°ƒæ•´åˆ° 16G äº†ã€‚ç¬¬ä¸€ååº”æ˜¯ GC æœ‰é—®é¢˜ï¼Œäº†è§£åˆ°ä»–ä»¬æµæ°´çº¿çš„ç‰¹ç‚¹ä¸»è¦æ˜¯ä¿å­˜çš„åˆ¶å“æ–‡ä»¶ç‰¹åˆ«å¤§ï¼Œæ¯ä¸ªæ¥è¿‘ 1Gï¼Œå¹¶å‘åœ¨10æ¡å·¦å³åï¼Œå°±å¼€å§‹äº†åœ¨æµ‹è¯•ç¯å¢ƒå¤ç°ã€‚

æµ‹è¯•ç¯å¢ƒæœç„¶å‡ºç°äº†ç±»ä¼¼é—®é¢˜ï¼Œå†…å­˜å¼€å§‹æŒç»­å¢é«˜ï¼Œä½†æ˜¯æŸ¥çœ‹äº† JVM çš„å †å†…å­˜æŒ‡æ ‡ï¼ˆ`vm_memory_total_used`ï¼‰å‘ç°æ˜¯æ­£å¸¸ï¼Œå¹¶ä¸”è¿œå°äºä¸Šå›¾é‡Œé¢çš„å€¼ï¼ˆ700MB vs 2.1GBï¼‰ã€‚

![[memory-wss2.png]]

![[memory-under-pressure.png]]

çœ‹æ¥æ¨é«˜ Pod å†…å­˜ç”¨é‡çš„å…ƒå‡¶å¦æœ‰å…¶äººã€‚

## è®¤è¯† WSS

æ—¢ç„¶æ˜¾ç¤ºå¼‚å¸¸çš„æŒ‡æ ‡æ˜¯ `pod_memory_working_set_bytes` ï¼Œé‚£æˆ‘ä»¬å…ˆæ¥è®¤è¯†ä¸€ä¸‹å®ƒã€‚

è™½ç„¶ Java åº”ç”¨ç”³è¯·å’Œé‡Šæ”¾çš„å†…å­˜æ˜¯ç”± JVM æ¥ç®¡ç†ï¼Œç„¶è€Œå½“æ¶‰åŠåˆ°çš„å†…å­˜ç”³è¯·é‡Šæ”¾ä¸å†…æ ¸ç›¸å…³æ—¶ï¼Œä¾¿ä¸å†æ˜¯JVMå¯ä»¥æ§åˆ¶ï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ Linux å†…æ ¸æ˜¯å¦‚ä½•åˆ’åˆ†å†…å­˜çš„ã€‚

æ³¨æ„ï¼Œåœ¨å¼€å§‹ä¸‹é¢çš„å†…å®¹ä¹‹å‰æˆ‘éœ€è¦æé†’ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä»¬çš„è§†è§’å‘ç”Ÿäº†ä¸€æ¬¡è½¬å˜ï¼šåˆšæ‰æˆ‘ä»¬ä¸€ç›´åœ¨ä»ç”¨æˆ·æ€ï¼Œå…·ä½“æ¥è¯´æ˜¯ JVM çš„è§†è§’æ¥çœ‹å¾…å†…å­˜åˆ†é…ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼Œå…·ä½“æ¥è¯´æ˜¯ **VMï¼ˆVirtual Memoryï¼‰çš„è§†è§’**æ¥ç†è§£å†…å­˜åœ¨æ“ä½œç³»ç»Ÿè¿™ä¸€å±‚é¢æ˜¯å¦‚ä½•åˆ†é…å’Œç®¡ç†çš„ã€‚

æˆ‘ä»¬çŸ¥é“VMä¸»è¦æœ‰ä¸‰ä¸ª[ä½œç”¨](https://docs.kernel.org/admin-guide/mm/concepts.html)ï¼š
1. ä½œä¸ºç£ç›˜çš„ç¼“å­˜ï¼›
2. ç»Ÿä¸€è¿›ç¨‹çš„å†…å­˜åœ°å€ï¼Œç®€åŒ–å†…å­˜ç®¡ç†ï¼›
3. ä¿æŠ¤è¿›ç¨‹è®¿é—®è¾¹ç•Œï¼›

VM é€šè¿‡é¡µè¡¨ï¼ˆPage Tableï¼‰æ¥å®ç°è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ï¼Œæ‰€æœ‰çš„æ•°æ®åœ¨ VM çš„è§†è§’é‡Œéƒ½æ˜¯é¡µï¼ˆPageï¼‰ï¼Œä½†æ˜¯é¡µæ ¹æ®ä½œç”¨å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

### Page Cache

ä½œä¸ºæ–‡ä»¶ç¼“å­˜ï¼Œé€šå¸¸æ˜¯æŒ‡ä»æ–‡ä»¶ä¸­è¯»å–åˆ°å†…å­˜çš„é‚£éƒ¨åˆ†ï¼Œç”¨æ¥åŠ é€Ÿæ–‡ä»¶ä»ç£ç›˜è¯»å–ã€‚ç›¸åº”åœ°ï¼Œå†™æ–‡ä»¶æ—¶ä¹Ÿä¼šå…ˆæ”¾ç½®åˆ° Page Cache å¹¶æ ‡è®°ä¸ºè„é¡µï¼Œç›´åˆ°åˆé€‚çš„æ—¶æœºè¢« flush åˆ°ç£ç›˜ä¸Šã€‚è¿™éƒ¨åˆ†å†…å­˜å¯ä»¥ç›´æ¥è¢«å›æ”¶ã€‚
### Anonymous Memory

åŒ¿åå†…å­˜æ˜¯æŒ‡ä¸èƒ½ä»¥ç£ç›˜æ–‡ä»¶ä½œä¸ºåå¤‡ï¼ˆfile-backed cacheï¼‰çš„é‚£éƒ¨åˆ†ï¼Œä¸€èˆ¬è¢«éšå¼åœ°åˆ›å»ºå‡ºæ¥ç»™è¿›ç¨‹çš„æ ˆæˆ–è€…å †ä½¿ç”¨ï¼Œæˆ–è€…æ˜¯æ˜¾å¼åœ°è°ƒç”¨system call `mmap(2)` æ—¶åˆ›å»ºã€‚ è¿™éƒ¨åˆ†å†…å­˜é€šå¸¸æ˜¯è¿›ç¨‹å¯ä»¥è®¿é—®çš„ï¼Œå½“ç¨‹åºéœ€è¦å†™å†…å®¹æ—¶ï¼ˆè¿™ä¸ªå†™æ˜¯æŒ‡åˆ›å»ºå¯¹è±¡ç­‰å†…å­˜æ“ä½œï¼‰è¢«åˆ›å»ºå¹¶è¢«æ ‡è®°ä¸ºè„é¡µï¼Œå¹¶åœ¨è¢«å›æ”¶çš„æ—¶å€™è¢«æ¢å‡ºï¼ˆswapped outï¼‰ã€‚

> å…³äºä¸ºä»€ä¹ˆå«â€œåŒ¿åâ€å†…å­˜ï¼šå› ä¸ºè¿™éƒ¨åˆ†å†…å®¹çš„ä½¿ç”¨ç›®çš„å¯¹äº Linux å†…æ ¸æ¥è¯´å®Œå…¨æ˜¯æœªçŸ¥çš„ï¼ˆç”±åº”ç”¨å†³å®šï¼‰ï¼Œæ‰€ä»¥å«åŒ¿åï¼Œæ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬ä½œä¸ºåº”ç”¨å¼€å‘è€…çš„è§†è§’å®Œå…¨ç›¸åï¼Ÿ

å…¶ä»–æ›´ç»†è‡´çš„åˆ†ç±»ï¼Œæ¯”å¦‚ `cat /proc/meminfo` æ—¶æ˜¾ç¤ºçš„ç»“æœå°±æ˜¯è¿™ä¸€åŸºç¡€ä¸Šæ›´ç»†çš„åˆ’åˆ†å’Œæ‰©å……ï¼ŒåƒBufferså’ŒCachedéƒ½æ˜¯å±äº Page Cache ï¼Œ Active(file) + Inactive(file) + Shmem ä¹Ÿç­‰äº Page Cacheã€‚éœ€è¦æ›´æ·±å…¥çš„å­¦ä¹ å¯ä»¥å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](https://www.baeldung.com/linux/proc-meminfo)ã€‚

### ç»Ÿè®¡å£å¾„

å›åˆ°æˆ‘ä»¬çš„é—®é¢˜æ¥ï¼ŒcAdvisor æš´éœ²äº†ä¸€ç³»åˆ—å®¹å™¨åœ¨[linuxå†…æ ¸å±‚é¢çš„æŒ‡æ ‡](https://www.baeldung.com/ops/kubernetes-container-memory-metrics)ï¼Œæ¯”å¦‚ï¼š

1. _container_memory_usage_bytes_ï¼Œå®¹å™¨ä½¿ç”¨çš„æ€»å†…å­˜ï¼Œè¿™ä¸ªæŒ‡æ ‡ç”±äºåŒ…å« Page Cache é€šå¸¸è¢«è®¤ä¸ºæ˜¯ä¸å¤ªå…·æœ‰ä»£è¡¨æ€§çš„ï¼ˆå› ä¸ºå®ƒå¢é«˜å¹¶ä¸ä¸€å®šä¼šè¯±å‘é—®é¢˜ï¼‰ï¼›
2. _container_memory_cache_ï¼Œå®¹å™¨æ–‡ä»¶è¯»å†™äº§ç”Ÿçš„ç¼“å­˜ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ Page Cacheï¼›
3. _container_memory_rss_ï¼ŒåŒ¿åå†…å­˜+ swap ç¼“å­˜ï¼Œæ³¨æ„è¿™ä¸æ˜¯æˆ‘ä»¬å¸¸è¯´çš„ RSSï¼ˆResident Set Sizeï¼‰ï¼ŒRSS è¿˜åŒ…å«æ–‡ä»¶æ˜ å°„ç¼“å­˜ï¼ˆmemory mapped fileï¼‰ã€‚ï¼ˆä¸€ä¸ªé—®é¢˜ï¼šKubernetesèŠ‚ç‚¹å¼ºåˆ¶å…³é—­ Swap ï¼Œé‚£ swap ç¼“å­˜ä¸æ˜¯æ°¸è¿œæ˜¯0å—ï¼Ÿï¼‰ï¼›
4. _container_memory_working_set_bytes_ï¼ŒåŒ¿åå†…å­˜+æ´»è·ƒçš„Page Cacheï¼Œé€šå¸¸æœ€æ¥è¿‘åº”ç”¨æœ€è¿‘ä½¿ç”¨çš„å†…å­˜ï¼›

## åˆ†æ

æœ‰äº†ä»¥ä¸ŠèƒŒæ™¯çŸ¥è¯†æˆ‘ä»¬å†æ¥çœ‹è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åˆ†æå‡ºæ¥å¢é•¿çš„é‚£éƒ¨åˆ†å°±æ˜¯ Active Page Cacheï¼ŒæŠŠä¸‰ä¸ªæŒ‡æ ‡éƒ½å±•ç¤ºå‡ºæ¥ç¡®å®å¦‚æ­¤ï¼š

![[container-memory-usage1.png]]

æ‹‰é•¿æ—¶é—´çº¿ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™éƒ¨åˆ†å†…å­˜åœ¨é€æ¸å‡å°‘ï¼Œä½†æ˜¯ working set size å´æ²¡æœ‰å¤ªå¤§å˜åŒ–ï¼ˆç”šè‡³æœ‰å¢åŠ ï¼‰
![[container-memory-usage2.png]]

åŠ å…¥ JVM ç›¸å…³çš„æŒ‡æ ‡ï¼Œå¯ä»¥çœ‹å‡ºå¢é•¿çš„éƒ¨åˆ†ä¸»è¦æ¥è‡ª JVM çš„ heap committedï¼Œå³å‘æ“ä½œç³»ç»Ÿç”³è¯·åˆ°çš„å¯è¢«ç”¨æ¥åˆ†é…çš„å†…å­˜å¤§å°ï¼š
![[container-memory-usage3.png]]

æœ€æœ‰è¶£çš„æ˜¯ï¼Œå½“WSSä¸€è·¯å¢é•¿åˆ°æ¥è¿‘ `vm_memory_heap_max` æ—¶è§¦å‘äº† JVM çš„GCï¼Œå†…å­˜è¢«é‡Šæ”¾ï¼ŒWSSã€heap committed ä¹Ÿå¼€å§‹éšä¹‹ä¸‹é™ã€‚

> å…³äºä¸ºä»€ä¹ˆç¬¬ä¸€å¼ å›¾æ˜¾ç¤ºçš„ WSS ç”šè‡³è¶…è¿‡äº† Limitsï¼Œæ˜¯å› ä¸ºæ„å¤–åˆ›å»ºäº†2ä¸ª `kube-prometh-kubelet` Serviceï¼Œå¯¼è‡´æŒ‡æ ‡æ±‚å’Œåè¢«doubleäº† ğŸ˜°
## ä¼˜åŒ–

æœ€åæˆ‘ä»¬æ¥è®¨è®ºä¸‹ï¼Œpage cache æ˜¯å¦çœŸçš„â€œå®‰å…¨â€ï¼Œä¸å€¼å¾—æˆ‘ä»¬æ‹…å¿ƒä¼šå¯¼è‡´åº”ç”¨OOMï¼Ÿ

å‡è®¾ä¸€ç§æç«¯æƒ…å†µï¼ŒçŸ­æ—¶é—´å†… Jenkins æ¥æ”¶åˆ°äº†å¤§é‡çš„å¤§æ–‡ä»¶ï¼Œä½†æ˜¯ç£ç›˜IOçš„æ€§èƒ½åˆè·Ÿä¸ä¸Šï¼Œå¯¼è‡´å¤§é‡è„é¡µäº§ç”Ÿï¼ŒPage Cache åœ¨å†…å­˜ä¸­çš„å æ¯”ä¸æ–­æé«˜ã€‚å½“ç¨‹åºéœ€è¦ç”³è¯·åŒ¿åå†…å­˜æ—¶ï¼Œä¾¿ä¼šè§¦å‘ Direct Reclaim ï¼Œè®©åº”ç”¨ç¨‹åºç­‰å¾…ï¼Œç›´åˆ°å†…æ ¸æˆåŠŸå›æ”¶è¶³å¤Ÿçš„å†…å­˜ã€‚ä½†æ˜¯å‡å¦‚ç”±äºä¸¥é‡çš„ç£ç›˜æ•…éšœæˆ–è€…æ˜¯ NFSç½‘ç»œé—®é¢˜ï¼Œå†…æ ¸å§‹ç»ˆæ— æ³•å›æ”¶æ—¶ï¼Œä¾¿ä¼šè§¦å‘ OOMã€‚

æ€»çš„æ¥è¯´ï¼ŒPage Cacheè¿‡é«˜ä¸ä¼šå¯¼è‡´è¿›ç¨‹è¢«OOMï¼Œä¸Šé¢è¿™ç§åœºæ™¯ä¸€èˆ¬é€šè¿‡ç›‘æ§ Buffersï¼ŒDirty Pages æˆ–è€…æ˜¯ IO wait ä¹Ÿèƒ½æå‰å‘ç°ï¼Œè¿™é‡Œ ChatGPT æ•´ç†äº†ä¸€å¼ è¡¨ï¼Œæˆ‘æ„Ÿè§‰æŒºå®Œæ•´çš„ï¼š

| è§‚å¯ŸæŒ‡æ ‡                           | æ­£å¸¸å€¼     | å¼‚å¸¸å€¼ï¼ˆè¦è­¦æƒ•ï¼‰                |
| ------------------------------ | ------- | ----------------------- |
| MemAvailableï¼ˆ/proc/meminfoï¼‰    | >20%æ€»å†…å­˜ | <10%ï¼Œä¸¥é‡è­¦æƒ•               |
| Buffers+Cachedï¼ˆ/proc/meminfoï¼‰  | åˆç†      | å ç”¨ >30%æ€»å†…å­˜ä¸” Available å°‘ |
| Dirty Pagesï¼ˆ/proc/meminfoï¼‰     | <1%æ€»å†…å­˜  | DirtyæŒç»­å¢é•¿ï¼Œè¯´æ˜å›å†™å¡         |
| vmstat wa ï¼ˆvmstat 1 5ï¼‰         | <5%     | wa >10%ï¼ŒIOé˜»å¡é‡           |
| blockedè¿›ç¨‹ï¼ˆbåˆ—ï¼‰ï¼ˆvmstat 1 5ï¼‰      | 0       | æŒç»­b>0ï¼Œä¸¥é‡IOå¡             |
| sar pgscan/pgstealï¼ˆsar -B 1 5ï¼‰ | ä½       | æŒç»­é«˜ï¼Œå†…å­˜å›æ”¶å‹åŠ›å¤§             |

### å†…æ ¸è°ƒä¼˜

å¦‚æœæœåŠ¡å™¨æœ¬èº«å°±æ˜¯åƒ Jenkins è¿™ç§IOè´Ÿè½½æ¯”è¾ƒé‡ï¼ŒåŒ…å«å¤§é‡è¯»å†™æ–‡ä»¶çš„åœºæ™¯ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–å‘¢ï¼Ÿ

**è°ƒ vm.dirty_background_ratio / vm.dirty_ratio**

```bash
# 5%å†…å­˜æ˜¯è„é¡µå°±å¼€å§‹åå°åŒæ­¥ï¼Œæœ€å¤šå…è®¸10%
sysctl -w vm.dirty_background_ratio=5
sysctl -w vm.dirty_ratio=10
```

**è°ƒé«˜ vm.vfs_cache_pressure**

```bash
# é»˜è®¤100ï¼Œè°ƒé«˜æ„å‘³ç€æ›´ç§¯æå›æ”¶inode/dentry cache
sysctl -w vm.vfs_cache_pressure=200
```


### åŠ é¤ï¼šå†…å­˜å›æ”¶æµç¨‹

1. ç¨‹åºåœ¨ç”³è¯·æ–°çš„å†…å­˜ï¼ˆå¦‚ `malloc(1GB)`ï¼‰ã€‚
2. å†…æ ¸å‘ç°ï¼šå½“å‰ç©ºé—²é¡µï¼ˆFree Pagesï¼‰ä¸è¶³ï¼Œæ²¡æ³•ç›´æ¥æ»¡è¶³ã€‚
3. å†…æ ¸å°±**ç›´æ¥åœ¨ç”³è¯·å†…å­˜çš„é‚£ä¸ªè¿›ç¨‹ä¸Šä¸‹æ–‡é‡Œ**ï¼Œå¼€å§‹åšâ€œå›æ”¶â€å·¥ä½œï¼ˆreclaimï¼‰ï¼š
    - å›æ”¶ LRU é¡µï¼ˆæœ€è¿‘æœ€å°‘ä½¿ç”¨çš„å†…å­˜é¡µï¼‰ï¼›
    - æŠŠè„é¡µï¼ˆdirty pageï¼‰flushåˆ°ç£ç›˜ï¼›
    - é‡Šæ”¾ Page Cacheï¼›
    - é‡Šæ”¾ slab cache ç­‰ã€‚
4. **å¦‚æœ reclaim æˆåŠŸäº†**ï¼Œæœ‰äº†è¶³å¤Ÿçš„ free pagesï¼Œç»§ç»­å®Œæˆå†…å­˜ç”³è¯·ã€‚
5. **å¦‚æœ reclaim å¤±è´¥äº†**ï¼ˆå›æ”¶ä¸åˆ°è¶³å¤Ÿçš„é¡µï¼‰ï¼Œå¯èƒ½ä¼šè¿›å…¥ï¼š
    - **Compaction**ï¼ˆå†…å­˜ç¢ç‰‡æ•´ç†ï¼‰
    - **Direct Swap**ï¼ˆå¦‚æœæœ‰ swapï¼Œå°±å¾€ swap é‡Œæ‰”ï¼‰
    - **è§¦å‘ OOM Killer**ï¼ˆå†…å­˜çœŸçš„ä¸å¤Ÿï¼Œæ€è¿›ç¨‹ï¼‰
    

#### ä¸ºä»€ä¹ˆå« "Direct Reclaim"ï¼Ÿ

å› ä¸ºæ˜¯**ç›´æ¥**åœ¨ç”³è¯·å†…å­˜çš„è¿›ç¨‹é‡Œæ‰§è¡Œ reclaim æ“ä½œï¼Œä¸æ˜¯ç³»ç»Ÿåå°ï¼ˆkswapdï¼‰æ…¢æ…¢å¼‚æ­¥åšã€‚è€Œæ˜¯"ä½ æƒ³è¦å†…å­˜ï¼Œæˆ‘å†…æ ¸ç›´æ¥è®©ä½ ç­‰ä¸€ä¸‹ï¼Œæˆ‘ç°åœ¨é©¬ä¸Šå»æ‰¾å†…å­˜å›æ¥"ã€‚

æ‰€ä»¥ Direct Reclaim æœŸé—´ï¼Œè¿›ç¨‹å®é™…ä¸Šæ˜¯ **é˜»å¡ï¼ˆblockedï¼‰** çš„ã€‚ 

#### è¡¥å……ç»†èŠ‚

|ç‚¹|è¯´æ˜|
|:--|:--|
|ğŸ§¹ kswapd|Linux æœ‰ä¸ªåå°å†…æ ¸çº¿ç¨‹ kswapdï¼Œä¼šå¼‚æ­¥å›æ”¶å†…å­˜ï¼Œæ­£å¸¸æƒ…å†µä¸‹å°½é‡é å®ƒ|
|ğŸš¨ Direct reclaim|å½“ kswapd æ¥ä¸åŠæ¸…ç†ï¼Œæ‰ç”±åº”ç”¨è‡ªå·±è§¦å‘ Direct Reclaimï¼ˆåŒæ­¥å›æ”¶ï¼Œä½“éªŒå·®ï¼‰|
|ğŸ§¨ OOM killer|å¦‚æœ Direct Reclaim ä¹Ÿæ•‘ä¸äº†ï¼Œå°±è§¦å‘ OOM Killer æ€æ‰ä¸€äº›è¿›ç¨‹é‡Šæ”¾å†…å­˜|
|â³ stall|Direct Reclaim ä¼šå¯¼è‡´ç¨‹åº "alloc stalls"ï¼ˆåˆ†é…å¡é¡¿ï¼‰ï¼Œå¯ä»¥é€šè¿‡ `vmstat`ã€`/proc/vmstat` çœ‹ `pgalloc stall` ç»Ÿè®¡|

# æ€è€ƒ

è¿™ç¯‡æ–‡ç« å±•ç¤ºçš„å†…å®¹ä¸æ˜¯ä¸€ä¸ªçŸ­æœŸçš„é›†ä¸­çš„è¿‡ç¨‹ï¼Œæ–­æ–­ç»­ç»­æŒç»­äº†ä¸€å¹´ï¼Œå› ä¸ºæœ€è¿‘çš„ä¸€æ¬¡ä¸šåŠ¡é—®é¢˜æ‰æ·±åº¦æ€è€ƒå’Œç ”ç©¶äº†ä¸€æŠŠï¼Œç»“åˆä¹‹å‰çš„ä¸€äº›å‘ç°ä¸€èµ·æ•´ç†å‡ºæ¥ã€‚æœ€åæˆ‘æƒ³è¯´ï¼š
1. å†…å­˜é—®é¢˜æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§çš„é—®é¢˜ï¼Œä»åº”ç”¨ç¨‹åºåˆ°è¿è¡Œæ—¶åˆ°æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå†åˆ°äº‘ç¼–æ’å¹³å°ï¼Œæ¯ä¸ªç¯èŠ‚éƒ½å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å·¥ä½œä¸å¦‚é¢„æœŸï¼›
2. å¯è§‚æµ‹æ€§æ˜¯æˆ‘ä»¬æœ€å¤§çš„å¸®æ‰‹ï¼Œè€Œåˆ©ç”¨è¿™äº›æŒ‡æ ‡çš„å‰ææ˜¯å¯¹ç³»ç»Ÿå……åˆ†çš„ç†è§£ï¼›
3. å¤šè¾“å…¥ï¼Œå¤šè¾“å‡ºï¼Œä¸ä¼šå°±é—®AIï¼›

# å‚è€ƒ

- [Factors Affecting Garbage Collection Performance](https://docs.oracle.com/en/java/javase/17/gctuning/factors-affecting-garbage-collection-performance.html#GUID-5508674B-F32D-4B02-9002-D0D8C7CDDC75)
- [Tricky Kubernetes memory management for Java applications](https://danoncoding.com/tricky-kubernetes-memory-management-for-java-applications-d2f88dd4e9f6)  
- [Kuberneteså­¦ä¹ (å†è°ˆkubernetesä¸­çš„å„ç§å†…å­˜OOM)](https://izsk.me/2024/11/30/kubernetes-memory-talk/ )
- [Kubernetes Container Memory Metrics | Baeldung on Ops](https://www.baeldung.com/ops/kubernetes-container-memory-metrics)
- [Javaä¸šåŠ¡å®¹å™¨åäº‘åŸç”Ÿç›‘æ§ä¸­å†…å­˜ä½¿ç”¨ç‡é«˜é—®é¢˜åŸºæœ¬æ’æŸ¥æ€è·¯](https://bbs.huaweicloud.com/blogs/424370)
- [memory_working_set_size æ˜¯kubeleté©±é€çš„æŒ‡æ ‡](https://faun.pub/how-much-is-too-much-the-linux-oomkiller-and-used-memory-d32186f29c9d)
- [How much is too much? The Linux OOMKiller and â€œusedâ€ memory](https://faun.pub/how-much-is-too-much-the-linux-oomkiller-and-used-memory-d32186f29c9d)
- [æ·±å…¥ç†è§£ Page Cache](https://mazhen.tech/p/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-page-cache/)
- [The /proc/meminfo File in Linux](https://www.baeldung.com/linux/proc-meminfo)

[^1]: abcasa
